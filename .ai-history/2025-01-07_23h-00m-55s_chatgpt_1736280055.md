# Error executing vim.schedule lua callback : rktmb-deepseek-complete.lua:46: Invalid `col` : out of range

When `M.set_suggestion_extmark()` is called with the suggestion returned by the DeepSeek API, I get the following error:

```
Error executing vim.schedule lua callback : rktmb-deepseek-complete.lua:46: Invalid `col` : out of range
```

I have no data sample to reproduce this error, may be you can find it out.
Analyze the code and tell me what actions should be made.



# This is gpt-4o-mini answer (2k in, 0k out)

The error message you're encountering, `Invalid 'col' : out of range`, indicates that the column index being passed to the `vim.api.nvim_buf_set_extmark` function is not valid. This can happen if the column index is negative or exceeds the length of the line in the buffer.

### Analyzing the Code

The function `M.set_suggestion_extmark(suggestion)` is responsible for setting the virtual text extmarks based on the suggestion returned by the DeepSeek API. Here are the key points to consider:

1. **Column Index**: The column index is obtained from the current cursor position:
   ```lua
   local col = position[2]
   ```

2. **Row Calculation**: The function calculates the row for each line of the suggestion:
   ```lua
   local extmark_row = row + i - 1
   ```

3. **Setting Extmarks**: The extmarks are set using:
   ```lua
   vim.api.nvim_buf_set_extmark(current_buf, _G.ns_id, extmark_row, col, { virt_text = {{line, "Comment"}} })
   ```

### Potential Issues

1. **Column Out of Range**: If the cursor is at the end of a line, `col` will be equal to the length of the line, which is out of range for setting an extmark. The valid range for column indices is from `0` to `length_of_line - 1`.

2. **Empty Lines**: If the suggestion contains multiple lines and the cursor is at the end of an empty line, the `col` value may not correspond to a valid position in the next line.

### Suggested Fixes

To prevent the out-of-range error, you can modify the `M.set_suggestion_extmark` function as follows:

1. **Adjust Column Index**: Ensure that the column index is within the valid range before setting the extmark.

2. **Handle Empty Lines**: If the suggestion contains multiple lines, you may want to adjust the column for the first line of the suggestion.

Hereâ€™s an updated version of the `M.set_suggestion_extmark` function:

```lua
function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]

  -- Split the suggestion into lines
  local lines = vim.split(suggestion, '\n', true)

  -- Create virtual text segments for each line
  local virt_text_lines = {}
  for _, line in ipairs(lines) do
    table.insert(virt_text_lines, {line, "Comment"})
  end

  -- Insert each line as a separate extmark
  for i, line in ipairs(lines) do
    local extmark_row = row + i - 1 -- Increment the row for each line

    -- Adjust column if it's out of range
    if col > #line then
      col = #line -- Set col to the end of the line if it's out of range
    end

    if _G.current_extmark_id then
      -- Update existing extmark
      vim.api.nvim_buf_set_extmark(
        current_buf,
        _G.ns_id,
        extmark_row,
        col,
        {
          virt_text = {{line, "Comment"}},
        }
      )
    else
      -- Create new extmark
      _G.current_extmark_id = vim.api.nvim_buf_set_extmark(
        current_buf,
        _G.ns_id,
        extmark_row,
        col,
        {
          virt_text = {{line, "Comment"}},
        }
      )
    end
  end
end
```

### Summary of Changes

- Added a check to adjust the `col` value if it exceeds the length of the line.
- This should prevent the out-of-range error when setting extmarks.

### Testing

After making these changes, test the plugin again with various suggestions, especially those that may contain multiple lines or are empty, to ensure that the error no longer occurs.

