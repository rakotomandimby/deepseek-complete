# Propose inline suggestions from the random sentence generator

The final goal of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest.
But we are not going to implement all in one go, we are to make it step by step.

- Generate random sentences
- Make an inline suggestion from a random sentence when triggered.
- Have the possibility transform the inline suggestion into regular text (accepting the suggestion).
- Query the DeepSeek API to get suggestions from the content of the buffer.
- Use the DeepSeek API response to suggest completions (dont use the random sentences anymore)

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a multiline random sentence.
This is done.

## Step 2: Make an inline  suggestion from a random sentence when triggered.

When I am in a buffer and in INSERT mode and issue the key sequence `<M-PageDown>`,
The plugin to place de cursor at the end of the line and then insert an inline suggestion 
taken from a random sentence (which is multi line) picked from the list of sentences.
The suggestion appears in grey (#808080).
The suggestion pushes down the lines below it and does not overlap with the text below.
If I continue to type after the suggestion is displayed, the suggestion disappears.
As far as I type, I can trigger the suggestion again and if I continue to type, the suggestion disappears, again and again.

That is the desired behavior.

## Step 3: Have the possibility transform the inline suggestion into regular text (accepting the suggestion).

I want to transform the inline suggestion into regular text because I like that suggested sentence.

With the current `./plugin/init.lua` file,
I issue the `<M-PageUp>` key sequence, the suggestion is transformed into regular text.

But before the suggestion is transformed into regular text, I get the following error:

```
E5108: Error executing lua ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: attempt to get length of field 'current_suggestion' (a nil value)
stack traceback:
....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: in function 'accept_suggestion'
[string ":lua"]:1: in main chunk
```

Analyze the code and tell me what makes the error appear but the suggestion is transformed into regular text anyway.




# This is o1-preview answer (2k in, 3k out)

The error you're encountering occurs because of the order in which you're clearing the `_G.current_suggestion` variable in your `accept_suggestion` function. Let's dive into the code to understand why this error appears and yet the suggestion is transformed into regular text.

### The Error Message

```
E5108: Error executing lua ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: attempt to get length of field 'current_suggestion' (a nil value)
stack traceback:
....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: in function 'accept_suggestion'
[string ":lua"]:1: in main chunk
```

### Analysis of the Code

In your `accept_suggestion` function within `plugin/init.lua`, here's the relevant portion of the code around line 74:

```lua
-- Remove the extmark (inline suggestion)
vim.api.nvim_buf_del_extmark(bufnr, ns_id, _G.current_extmark_id)

-- Clear the stored extmark ID and suggestion
_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Optional: Move the cursor to the end of the inserted text
vim.api.nvim_win_set_cursor(0, { current_line + #_G.current_suggestion, 0 })
```

**Issue:** You're setting `_G.current_suggestion` to `nil` before you calculate its length with `#_G.current_suggestion`. As a result, when you try to compute `#_G.current_suggestion`, you're effectively trying to get the length of `nil`, which causes the error: `attempt to get length of field 'current_suggestion' (a nil value)`.

Despite this error, the suggestion is transformed into regular text because the insertion into the buffer happens **before** the error occurs:

```lua
-- Insert the suggestion lines into the buffer
-- Lines are inserted below the current line
vim.api.nvim_buf_set_lines(bufnr, current_line, current_line, false, _G.current_suggestion)
```

### Solution

To fix the error, you need to rearrange the order of operations in your `accept_suggestion` function so that you're not trying to access `_G.current_suggestion` after you've set it to `nil`.

**Revised `accept_suggestion` Function:**

```lua
_G.accept_suggestion = function()
  if not _G.current_extmark_id or not _G.current_suggestion then
    -- No active suggestion to accept
    return
  end

  local bufnr = 0
  local cursor_pos = vim.api.nvim_win_get_cursor(0)
  local current_line = cursor_pos[1]

  -- Insert the suggestion lines into the buffer
  -- Lines are inserted below the current line
  vim.api.nvim_buf_set_lines(bufnr, current_line, current_line, false, _G.current_suggestion)

  -- Optional: Move the cursor to the end of the inserted text
  vim.api.nvim_win_set_cursor(0, { current_line + #_G.current_suggestion, 0 })

  -- Remove the extmark (inline suggestion)
  vim.api.nvim_buf_del_extmark(bufnr, ns_id, _G.current_extmark_id)

  -- Clear the stored extmark ID and suggestion
  _G.current_extmark_id = nil
  _G.current_suggestion = nil
end
```

**Explanation:**

- **Move Cursor Before Clearing Suggestion:** By moving the cursor adjustment code **before** you set `_G.current_suggestion` to `nil`, you ensure that you're accessing a valid value when computing `#_G.current_suggestion`.
- **Order of Operations:** The corrected order is:
  1. **Insert** the suggestion into the buffer.
  2. **Move the cursor** based on the length of the suggestion.
  3. **Delete** the extmark.
  4. **Clear** the stored extmark ID and suggestion.

### Why the Suggestion Was Inserted Despite the Error

The insertion of the suggestion into the buffer happens before the error-causing code. Therefore, even though an error occurs later in the function, the earlier operations have already been executed successfully, resulting in the suggestion being transformed into regular text.

### Conclusion

By adjusting the order in which you clear `_G.current_suggestion`, you eliminate the error. The function now only attempts to access `_G.current_suggestion` while it contains a valid value. This change should prevent the error from appearing, and your plugin should work as intended.

### Updated Function Without Error

Here's the complete `accept_suggestion` function after applying the fix:

```lua
_G.accept_suggestion = function()
  if not _G.current_extmark_id or not _G.current_suggestion then
    -- No active suggestion to accept
    return
  end

  local bufnr = 0
  local cursor_pos = vim.api.nvim_win_get_cursor(0)
  local current_line = cursor_pos[1]

  -- Insert the suggestion lines into the buffer
  -- Lines are inserted below the current line
  vim.api.nvim_buf_set_lines(bufnr, current_line, current_line, false, _G.current_suggestion)

  -- Optional: Move the cursor to the end of the inserted text
  vim.api.nvim_win_set_cursor(0, { current_line + #_G.current_suggestion, 0 })

  -- Remove the extmark (inline suggestion)
  vim.api.nvim_buf_del_extmark(bufnr, ns_id, _G.current_extmark_id)

  -- Clear the stored extmark ID and suggestion
  _G.current_extmark_id = nil
  _G.current_suggestion = nil
end
```

**Note:** Remember that Lua tables (which `_G.current_suggestion` is, in this case) need to be accessed while they're still valid. Clearing them before usage will almost always cause an error.

---

Let me know if you have any more questions or need further assistance with your project!

