  for i, line in ipairs(lines) do
      -- when getting here, the cursor is already at the end of the line
      -- so we just need to set the extmark at the current cursor position
      -- 
      -- change the line below not to use initial_cursor_pos but to use the current cursor position
      local extmark_id = vim.api.nvim_buf_set_extmark(bufnr, ns_id, initial_cursor_pos[1] + i - 1, initial_cursor_pos[2] - 1, {  -- Use initial_cursor_pos for both line *and* column, and adjust for zero-indexing
        virt_text = { { line, "InlineSuggestion" } },
        virt_text_pos = 'overlay',
      })
      table.insert(_G.current_extmarks, { ns = ns_id, id = extmark_id })
  end




# This is gemini-2.0-flash-thinking-exp answer (1k in, 0k out)

You're right, using `initial_cursor_pos` after moving the cursor is incorrect.  You need to get the cursor position *after* moving to the end of the line.  Here's the corrected `show_suggestion` function:

```lua
-- Function to show the suggestion when triggered
local function show_suggestion()
  clear_suggestion()

  -- Get the current buffer
  local bufnr = vim.api.nvim_get_current_buf()

  -- Move the cursor to the end of the line
  vim.api.nvim_feedkeys(vim.api.nvim_replace_termcodes("<Esc><End>a", true, false, true), 'n', true)

  -- Generate a random sentence
  local suggestion = rktmb_deepseek_complete.generate_sentence()
  rktmb_deepseek_complete.log("Generated suggestion: " .. suggestion)

  -- Split the suggestion into lines
  local lines = vim.split(suggestion, "\n")

  -- Create a namespace for our extmarks
  local ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

  -- Set extmarks for each line of the suggestion
  _G.current_extmarks = {}

  -- Get the cursor position *AFTER* moving to the end of the line
  local current_cursor_pos = vim.api.nvim_win_get_cursor(0)


  for i, line in ipairs(lines) do
    local extmark_id = vim.api.nvim_buf_set_extmark(bufnr, ns_id, current_cursor_pos[1] + i - 1, current_cursor_pos[2] -1 , {
      virt_text = { { line, "InlineSuggestion" } },
      virt_text_pos = 'overlay',
    })
    table.insert(_G.current_extmarks, { ns = ns_id, id = extmark_id })
  end

end
```

Key changes:

* **Removed `initial_cursor_pos`:**  We no longer need to store the initial cursor position.
* **Added `current_cursor_pos`:** This variable now correctly stores the cursor position *after* moving to the end of the line.
* **Used `current_cursor_pos` in `nvim_buf_set_extmark`:** The extmarks are now placed relative to the correct, updated cursor position.  The column is offset by -1 to place the virtual text *after* the cursor.



This revised code should correctly display the inline suggestions at the end of the current line, regardless of the initial cursor position within the line.  Remember to replace the existing `show_suggestion` function in your `plugin/init.lua` file with this updated version.
