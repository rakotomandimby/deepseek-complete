# Invalid `end_row` : out of range

When `M.set_suggestion_extmark()` is called with the suggestion returned by the DeepSeek API, I get the following error:

```
Error executing vim.schedule lua callback : rktmb-deepseek-complete.lua:57: Invalid `end_row` : out of range
```

I have no data sample to reproduce this error, may be you can find it out.
Analyze the code and tell me what actions should be made.




# This is gpt-4o-mini answer (2k in, 0k out)

The error message `Invalid end_row: out of range` indicates that the `end_row` value being passed to the `vim.api.nvim_buf_set_extmark` function is exceeding the number of lines in the buffer. This can happen if the suggestion returned by the DeepSeek API is longer than the available lines in the buffer or if the cursor is positioned at the end of the buffer.

### Analyzing the Code

In the `M.set_suggestion_extmark(suggestion)` function, the `end_row` is calculated as follows:

```lua
end_row = row + #vim.split(suggestion, '\n', true) - 1
```

Here, `row` is the current line number (0-based), and `#vim.split(suggestion, '\n', true)` gives the number of lines in the suggestion. If the cursor is at the last line of the buffer, adding the number of lines in the suggestion to `row` could result in an `end_row` that exceeds the total number of lines in the buffer.

### Suggested Fixes

1. **Check Buffer Length**: Before setting the extmark, check if the calculated `end_row` exceeds the number of lines in the buffer. If it does, adjust it to the last line of the buffer.

2. **Adjust the `end_row` Calculation**: Modify the `set_suggestion_extmark` function to ensure that `end_row` does not exceed the buffer's line count.

Hereâ€™s how you can implement these changes:

```lua
function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]

  -- Calculate the number of lines in the current buffer
  local buffer_line_count = vim.api.nvim_buf_line_count(current_buf)
  local suggestion_lines = #vim.split(suggestion, '\n', true)
  local end_row = row + suggestion_lines - 1

  -- Ensure end_row does not exceed the buffer's line count
  if end_row >= buffer_line_count then
    end_row = buffer_line_count - 1
  end

  if _G.current_extmark_id then
    -- Update existing extmark
    vim.api.nvim_buf_set_extmark(current_buf, _G.ns_id, _G.current_extmark_id, {
      row = row,
      col = col,
      opts = {
        end_row = end_row,
        end_col = string.len(vim.split(suggestion, '\n', true)[#vim.split(suggestion, '\n', true)]),
        virt_text =  {{suggestion, "Comment"}},
        virt_text_pos = "overlay"
      }
    })
  else
    -- Create new extmark
    _G.current_extmark_id = vim.api.nvim_buf_set_extmark(
      current_buf, 
      _G.ns_id, 
      row, 
      col, 
      {
        end_row = end_row,
        end_col = string.len(vim.split(suggestion, '\n', true)[#vim.split(suggestion, '\n', true)]),
        virt_text = {{suggestion, "Comment"}},
        virt_text_pos = "overlay"
      }
    )
  end
end
```

### Summary of Changes

- **Buffer Line Count**: Added a check to get the total number of lines in the buffer using `vim.api.nvim_buf_line_count(current_buf)`.
- **End Row Adjustment**: Before setting the extmark, the `end_row` is adjusted to ensure it does not exceed the buffer's line count.

### Testing

After making these changes, test the plugin again with various suggestions, especially those that might be longer than the available lines in the buffer. This should resolve the `Invalid end_row: out of range` error.

