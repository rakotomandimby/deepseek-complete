# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.
Also, now, if in INSERT mode and the user presses the space key, `suggest()` is called.

That is the behavior I want.

## Step 4: Insert the suggestion as extmark

Now the suggestion returned by the DeepSeek API is inserted as an extmark.
The extmark starts after the cursor position, NOT at the end of the line.

Problem: The DeepSeek API response is a multiline string and it is displayed with `^@` at the end of each line.

Tell me what modifications I need to make to the code in order to really split the suggestion into lines.




# This is gemini-exp-1206 answer (3k in, 0k out)

The `^@` you're seeing represents the newline character (`\n`).  The issue isn't that the lines aren't being split; it's that Neovim's virtual text doesn't automatically render newlines.  You need to create *separate virtual text segments* for each line of the suggestion.

Here's the modified `lua/rktmb-deepseek-complete.lua` file:

```lua
-- lua/rktmb-deepseek-complete.lua
local M = {}

-- ... (Existing functions: log, remove_markdown_delimiters, get_text_before_cursor,
--      get_text_after_cursor, get_text_before_cursor_line, get_open_buffers,
--      get_buffer_content, get_current_buffer_name, build_messages_table remain unchanged)

function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]

  -- Split the suggestion into lines
  local lines = vim.split(suggestion, '\n', true)

  -- Create virtual text segments for each line
  local virt_text_lines = {}
  for _, line in ipairs(lines) do
    table.insert(virt_text_lines, {line, "Comment"})
  end


  if _G.current_extmark_id then
    -- Update existing extmark
    vim.api.nvim_buf_set_extmark(
      current_buf,
      _G.ns_id,
      row,
      col,
      {
        virt_text = virt_text_lines,
        virt_text_pos = "overlay"
      }
    )
  else
    -- Create new extmark
    _G.current_extmark_id = vim.api.nvim_buf_set_extmark(
      current_buf,
      _G.ns_id,
      row,
      col,
      {
        virt_text = virt_text_lines,
        virt_text_pos = "overlay"
      }
    )
  end
end


return M
```

**Explanation of Changes:**

1. **Splitting the Suggestion:** The `suggestion` string is split into a table of lines using `vim.split(suggestion, '\n', true)`.

2. **Creating Virtual Text Lines:**  The code now iterates through the `lines` table and creates a table of virtual text segments, `virt_text_lines`. Each segment is a table containing the line text and the highlighting group ("Comment").

3. **Setting the Virtual Text:** The `virt_text` property of the extmark is now set to the `virt_text_lines` table.  This tells Neovim to render each element of the table as a separate line of virtual text.  We no longer need `end_row` and `end_col` because the virtual text handles the multiline display automatically.



No changes are needed in your `plugin/init.lua` file for this specific fix.  The core issue was how the virtual text was being constructed, not how the API response was handled.  This change ensures each line of the suggestion is displayed correctly in the virtual text overlay.

