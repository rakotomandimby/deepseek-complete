# Propose inline suggestions from the random sentence generator

The final goal of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest.
But we are not going to implement all in one go.
We are to make it step by step.

- Generate a random sentences
- Make an inline suggestion from a random sentence when triggered.
- Query the DeepSeek API to get suggestions from the content of the buffer.
- Use the DeepSeek API response to suggest completions (dont use the random sentences anymore)

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a multiline random sentence.

## Step 2: Make an inline  suggestion from a random sentence when triggered.

When I am in a buffer and in INSERT mode and issue the key sequence `<M-PageDown>`,
the plugin suggests with a random sentence picked from the list of sentences. 
The suggestion text appears in grey.

If the sentence contains a newline, the suggestion is splat into multiple lines.

That is good.


But sometimes, If I put the cursor on any word or line then trigger the completion, I get the following error:

```
Error executing vim.schedule lua callback: ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:41: Invalid 'col': out of range
stack traceback:
        [C]: in function 'nvim_buf_set_extmark'
        ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:41: in function ''
        vim/_editor.lua: in function ''
        vim/_editor.lua: in function <vim/_editor.lua:0>
```

Analyze the code and find all causes possible to get the error above and propose me a fix.



# This is gemini-2.0-flash-thinking-exp answer (1k in, 0k out)

The error `Invalid 'col': out of range` for `nvim_buf_set_extmark` happens when the column value you're providing exceeds the length of the line.  This is occurring in your code because the `current_col` can be beyond the end of the line, especially if the user is at the end of a line and presses `<M-PageDown>`.

Here's the corrected `plugin/init.lua` file:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

vim.api.nvim_set_hl(0, "InlineSuggestion", { fg = "#808080", bg = "NONE" })

_G.completion_handler = nil
_G.current_extmarks = nil

local function clear_suggestion()
    if _G.current_extmarks then
        for _, extmark in ipairs(_G.current_extmarks) do
            vim.api.nvim_buf_del_extmark(0, extmark.ns, extmark.id)
        end
        _G.current_extmarks = nil
    end
end

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        _G.completion_handler = function()
            local current_line = vim.api.nvim_get_current_line()
            local current_col = vim.api.nvim_win_get_cursor(0)[2]
            local current_word = vim.fn.expand("<cword>")

            local suggestion = rktmb_deepseek_complete.generate_sentence()
            local lines = vim.split(suggestion, "\n")
            -- log the lines
            rktmb_deepseek_complete.log("Lines:")
            for _, line in ipairs(lines) do
                rktmb_deepseek_complete.log(line)
            end
            rktmb_deepseek_complete.log("End of lines")

            clear_suggestion()

            local ns_id = vim.api.nvim_create_namespace("rktmb-deepseek-complete-ns")
            _G.current_extmarks = {}

            -- Fix: Ensure column is within line bounds
            local adjusted_col = math.min(current_col, #current_line)


            for i, line in ipairs(lines) do
                local extmark_id = vim.api.nvim_buf_set_extmark(0, ns_id, vim.api.nvim_win_get_cursor(0)[1] - 1 + i - 1, adjusted_col, {
                    virt_text = {{line, "InlineSuggestion"}},
                    virt_text_pos = "overlay",
                    hl_mode = "combine"
                })
                table.insert(_G.current_extmarks, {ns = ns_id, id = extmark_id})
            end
        end

        vim.keymap.set("i", "<M-PageDown>", function()
            vim.defer_fn(_G.completion_handler, 0)
            return ""
        end, { noremap = true, expr = true, silent = true })

        vim.api.nvim_create_autocmd("TextChangedI", {
            buffer = 0,
            once = true,
            callback = function()
                clear_suggestion()
            end
        })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        _G.completion_handler = nil
        clear_suggestion()
    end
})
```

The key change is this line:

```lua
local adjusted_col = math.min(current_col, #current_line)
```

This line now calculates the minimum of the current column and the length of the current line. This ensures that `adjusted_col` never exceeds the bounds of the line, preventing the `Invalid 'col': out of range` error.  The rest of the code remains the same.  This fix addresses the root cause of the error you were encountering.

