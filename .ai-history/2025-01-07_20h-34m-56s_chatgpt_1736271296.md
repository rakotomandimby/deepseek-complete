# E5560: Vimscript function must not be called in a Lua callback

In `./plugin/init.lua` I have a function `process_deepseek_response()` that is called in the callback of the curl request.
The problem is that the function `process_deepseek_response()` must decode a json string, but it is a vimscript function.

Propose me the changes needed to make to able to decode the json in the response.
I think about using something linke `vim.schedule`, `vim.schedule_wrap`, or any `vim.*` function that could help me.





# This is gpt-4o-mini answer (2k in, 0k out)

To resolve the issue of calling a Vimscript function from a Lua callback, you can use `vim.schedule` or `vim.schedule_wrap` to ensure that the function is executed in the correct context. This allows you to safely call Vimscript functions from within a Lua callback.

Hereâ€™s how you can modify your `plugin/init.lua` file to use `vim.schedule_wrap` for the `process_deepseek_response` function:

### Updated `plugin/init.lua`

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
local curl = require('plenary.curl')

_G.ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Default keymappings
local default_opts = {
  deepseek_api_key = os.getenv("DEEPSEEK_API_KEY"),
  suggest_lines_keymap = "<M-ESC>",
  accept_all_keymap = "<M-PageDown>",
  accept_line_keymap = "<M-Down>",
}

-- Read user configuration
local user_opts = vim.tbl_deep_extend("force", default_opts, vim.g.rktmb_deepseek_complete_opts or {})

-- Wrap the process_deepseek_response function to ensure it runs in the correct context
local function process_deepseek_response(response)
  vim.schedule(function()  -- Use vim.schedule to run this in the main thread
    local response_body = vim.fn.json_decode(response.body)
    if response_body.choices and #response_body.choices > 0 then
      local choice = response_body.choices[1]
      local suggestion = choice.message.content
      rktmb_deepseek_complete.log("\n\nSuggestion from DeepSeek API:")
      rktmb_deepseek_complete.log(suggestion)
    end
  end)
end

_G.suggest = function()
  local deepseek_request_body = {
    model = "deepseek-chat",
    echo = false,
    frequency_penalty = 0,
    max_tokens = 4096,
    presence_penalty = 0,
    stop = nil,
    stream = false,
    stream_options = nil,
    temperature = 1,
    top_p = 1,
    messages = rktmb_deepseek_complete.build_messages_table(
      rktmb_deepseek_complete.get_text_before_cursor(),
      rktmb_deepseek_complete.get_text_after_cursor()
    )
  }

  -- Asynchronously make the POST request
  curl.post('https://api.deepseek.com/chat/completions', {
    body = vim.fn.json_encode(deepseek_request_body),
    headers = {
      ["Content-Type"] = "application/json",
      ["Accept"] = "application/json",
      ["Authorization"] = "Bearer " .. user_opts.deepseek_api_key
    },
    callback = function(response)
      rktmb_deepseek_complete.log("Response from DeepSeek API:")
      rktmb_deepseek_complete.log(response.body)
      process_deepseek_response(response)  -- Call the wrapped function
    end
  })
end

vim.api.nvim_create_autocmd("InsertLeave", {
  pattern = "*",
  callback = function()
    vim.api.nvim_buf_clear_namespace(0, ns_id, 0, -1)
  end
})

vim.api.nvim_set_keymap("i", user_opts.suggest_lines_keymap, "<Cmd>lua suggest()<CR>",                     { noremap = true, silent = true })
-- vim.api.nvim_set_keymap("i", user_opts.accept_all_keymap,    "<Cmd>lua accept_the_whole_suggestion()<CR>", { noremap = true, silent = true })
-- vim.api.nvim_set_keymap("i", user_opts.accept_line_keymap,   "<Cmd>lua accept_one_suggestion_line()<CR>",  { noremap = true, silent = true })
-- vim.api.nvim_set_keymap("i", user_opts.accept_word_keymap   ,"<Cmd>lua accept_one_suggestion_word()<CR>",  { noremap = true, silent = true })
```

### Key Changes Made:
1. **Wrapped `process_deepseek_response`**: The function is now wrapped in `vim.schedule`, which ensures that it runs in the main thread, allowing it to safely call Vimscript functions like `vim.fn.json_decode`.

2. **Callback Execution**: The callback for the `curl.post` request now calls the wrapped `process_deepseek_response` function.

This change should resolve the E5560 error and allow you to decode the JSON response correctly.

