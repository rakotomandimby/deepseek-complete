# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence 
picked from the list of sentences. The suggestion text should appear in grey.

The problem is when I issue the key sequence `<M-PageDown>` just after entering INSERT mode, nothing is suggested.

I have to write one first, then press `<M-PageDown>` to see the suggestion.

Analyze the code and tell me what should I do to get the suggestion just after entering INSERT mode.



# This is gemini-2.0-flash-thinking-exp answer (1k in, 0k out)

The issue is that the completion handler relies on the current cursor column (`vim.api.nvim_win_get_cursor(0)[2]`), and when you enter insert mode at the beginning of a line or in an empty buffer, the column number is likely 0 or 1.  The completion then gets placed at an incorrect position, often overwriting existing text or appearing before the cursor.

Here's the corrected `plugin/init.lua` that addresses this and a few other minor improvements:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

_G.completion_handler = nil

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        -- Set the completion handler
        _G.completion_handler = function()
            local current_line, current_col = unpack(vim.api.nvim_win_get_cursor(0))
            local current_word = vim.fn.expand("<cword>")  -- Get the current word
            local suggestion = rktmb_deepseek_complete.generate_sentence()

            -- Create a completion item with the correct structure, including current word
            local completion_items = {
                { word = suggestion, kind = "Random Sentence", menu = "[random]", icase = 1, word = current_word }
            }


            -- Calculate correct start position for completion
            local start_col = current_col - #current_word  -- Adjust for current word length

            -- Trigger the completion at the correct position
            vim.fn.complete(start_col, completion_items)
        end

        -- Map <M-PageDown> after the handler is defined
        vim.keymap.set("i", "<M-PageDown>", function()
            vim.defer_fn(_G.completion_handler, 0) -- Use defer_fn to avoid issues
            return ""
        end, { noremap = true, expr = true, silent = true })
    end
})


vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        _G.completion_handler = nil -- Clear the handler when leaving insert mode
    end
})
```


Key Changes and Explanations:

1. **Get Current Word:**  The code now uses `vim.fn.expand("<cword>")` to get the current word under the cursor. This is crucial for proper completion behavior.

2. **Calculate Correct Start Column:** The `start_col` is calculated by subtracting the length of the current word (`#current_word`) from the current column (`current_col`). This ensures the completion starts at the beginning of the current word, even if it's at the beginning of the line.

3. **Use `defer_fn`:** The completion handler is now called using `vim.defer_fn(_G.completion_handler, 0)`. This is important because it ensures the completion is triggered *after* the `<M-PageDown>` keypress is fully processed, preventing potential issues.

4. **Include `word` field in completion item:** The `word` field is added to the completion item table. This tells Neovim which part of the current word should be replaced by the completion.  Without this, the completion would be *inserted* at the cursor position rather than *replacing* the current word.



With these changes, the completion should work correctly even at the beginning of a line or in an empty buffer.  The completion will now replace the current word (or nothing if there's no word under the cursor) with the suggested sentence.
