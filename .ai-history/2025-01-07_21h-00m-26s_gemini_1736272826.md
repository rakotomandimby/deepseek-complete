# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.
Also, now, if in INSERT mode and the user presses a letter key, a punctuation key, or a space, `suggest()` is called.

The problem is that `suggest()` is immediately called: I want to wait for the user to finish typing before calling it.

Tell me what modifications I need to make to the code in order to achieve that.




# This is gemini-exp-1206 answer (3k in, 1k out)

You're on the right track! The issue you're encountering is due to the immediate invocation of `suggest()` on every keypress.  You need to introduce a debounce mechanism to wait for a pause in typing before making the API call.  Here's how you can modify your `plugin/init.lua` to incorporate this:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
local curl = require('plenary.curl')

_G.ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Default keymappings
local default_opts = {
  deepseek_api_key = os.getenv("DEEPSEEK_API_KEY"),
  suggest_lines_keymap = "<M-ESC>",
  accept_all_keymap = "<M-PageDown>",
  accept_line_keymap = "<M-Down>",
  debounce_time = 500, -- Debounce time in milliseconds
}

-- Read user configuration
local user_opts = vim.tbl_deep_extend("force", default_opts, vim.g.rktmb_deepseek_complete_opts or {})

local timer = nil  -- Timer for debouncing

local function process_deepseek_response(response)
  -- ... (your existing process_deepseek_response function)
end

_G.suggest = function()
    -- Clear any existing timer
    if timer ~= nil then
        timer:stop()
    end


  -- Create a new timer
  timer = vim.defer_fn(function()
    local deepseek_request_body = {
        -- ... (your existing request body)
    }

    curl.post('https://api.deepseek.com/chat/completions', {
        -- ... (your existing curl options)
    })
  end, user_opts.debounce_time)
end


-- ... (rest of your plugin code)

-- Key mappings.  No <Cmd>lua suggest()<CR> directly anymore.
vim.api.nvim_set_keymap("i", user_opts.suggest_lines_keymap, "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })

-- For all letters, punctuation, and space, just call suggest which will now debounce
for i = 97, 122 do  -- a-z
  vim.api.nvim_set_keymap("i", string.char(i), "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })
end

for i = 65, 90 do  -- A-Z
  vim.api.nvim_set_keymap("i", string.char(i), "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })
end

local punctuation_keys = { "!", '"', "#", "$", "%%%%%%%%", "&", "'", "(", ")", "*", "+", ",", "-", ".", "/", ":", ";", "<", "=", ">", "?", "@", "[", "\\", "]", "^", "_", "`", "{", "|", "}", "~" }
for _, key in ipairs(punctuation_keys) do
  vim.api.nvim_set_keymap("i", key, "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })
end

vim.api.nvim_set_keymap("i", " ", "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })


-- ... (rest of your plugin code)

```

Key changes:

1. **Debounce Timer:** A `timer` variable is introduced to manage the debouncing.
2. **`vim.defer_fn`:** Inside `suggest()`, `vim.defer_fn` is used to schedule the API call after a delay specified by `user_opts.debounce_time`.  If the user types another character within that time, the previous timer is cancelled, and a new one is started. This ensures that `suggest()` is only called after a pause in typing.
3. **Configuration:** A `debounce_time` option is added to the default options, allowing users to customize the delay.
4. **Simplified Keymappings:** The keymappings are simplified.  They now just call `suggest()`. The debounce logic handles when to actually make the API call.


Now, the DeepSeek API call will only be triggered after the user pauses typing for the duration specified by `debounce_time`.  You can adjust this value in your configuration to fine-tune the responsiveness. Remember to require the module again in your Neovim config after making these changes.

