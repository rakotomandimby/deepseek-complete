# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence 
picked from the list of sentences. The suggestion text should appear in grey.

The problem is when I issue the key sequence `<M-PageDown>` just after entering INSERT mode, nothing is suggested.

I have to write one first, then press `<M-PageDown>` to see the suggestion.

Analyze the code and tell me what should I do to get the suggestion just after entering INSERT mode.



# This is gpt-4o-mini answer (1k in, 0k out)

To achieve the desired behavior of suggesting a random sentence immediately after entering INSERT mode, you need to modify the `InsertEnter` autocommand in your `plugin/init.lua` file. The current implementation only sets up the completion handler but does not trigger it right away when you enter INSERT mode.

Here’s how you can modify the code:

1. **Trigger the completion handler immediately after entering INSERT mode.**
2. **Ensure that the completion items are displayed correctly.**

Here’s the updated content for `plugin/init.lua`:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

_G.completion_handler = nil

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        -- Set the completion handler
        _G.completion_handler = function()
            local current_col = vim.api.nvim_win_get_cursor(0)[2]
            local suggestion = rktmb_deepseek_complete.generate_sentence()

            -- Create a completion item with the correct structure
            local completion_items = {
                { word = suggestion, kind = "Random Sentence", menu = "[random]", icase = 1 }
            }

            -- Trigger the completion
            vim.fn.complete(current_col + 1, completion_items)  -- Use current_col + 1 for the correct position
        end

        -- Trigger the completion immediately after entering insert mode
        vim.defer_fn(_G.completion_handler, 0)

        vim.keymap.set("i", "<M-PageDown>", function()
            vim.defer_fn(_G.completion_handler, 0)
            return ""
        end, { noremap = true, expr = true, silent = true })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        _G.completion_handler = nil -- Clear the handler when leaving insert mode
    end
})
```

### Key Changes Made:
- **Immediate Triggering of Completion**: The line `vim.defer_fn(_G.completion_handler, 0)` is added right after setting the completion handler. This will call the completion handler immediately after entering INSERT mode, thus suggesting a random sentence right away.
  
### Result:
With this change, when you enter INSERT mode, a random sentence will be suggested immediately, and you can still use `<M-PageDown>` to trigger it again if needed. The suggestion will appear in grey as specified by the completion item structure. 

Make sure to test this in your Neovim setup to confirm that it behaves as expected!

