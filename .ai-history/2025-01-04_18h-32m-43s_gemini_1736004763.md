# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence 
picked from the list of sentences. The suggestion text should appear in grey.

The problem is when I issue the key sequence `<M-PageDown>` in insert mode, nothing is suggested.

When I look in `/tmp/rktmb-deepseek-complete.log`, I see `Entered generate_sentence()`, so the plugin is actually trigerring the random sentence generation.

Analyze the code and tell me what should I do to fix the problem.



# This is gemini-2.0-flash-thinking-exp answer (1k in, 0k out)

The issue lies within the `complete()` function call.  You're using `vim.fn.complete()`, which expects a byte offset for the completion start.  However, you're providing `current_col`, which represents the column number (character count). These are different, especially with multibyte characters.  You need to calculate the byte offset.

Here's the corrected `plugin/init.lua`:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

_G.completion_handler = nil

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        -- Set the completion handler
        _G.completion_handler = function()
            local current_line = vim.api.nvim_get_current_line()
            local current_col = vim.api.nvim_win_get_cursor(0)[2]
            local current_word = vim.fn.expand("<cword>")

            local suggestion = rktmb_deepseek_complete.generate_sentence()

            -- Calculate byte offset
            local line_before_cursor = string.sub(current_line, 1, current_col -1)
            local byte_offset = vim.fn.byteidx(line_before_cursor, -1)


            vim.fn.complete(byte_offset, {
                { word = suggestion, kind = "random sentence", menu = "[random]", icase = 1, abbr = current_word }
            })
        end

        vim.keymap.set("i", "<M-PageDown>", function()
            vim.defer_fn(_G.completion_handler, 0)
            return ""
        end, { noremap = true, expr = true, silent = true })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        _G.completion_handler = nil -- Clear the handler when leaving insert mode
    end
})
```

The key change is the addition of these lines:

```lua
local line_before_cursor = string.sub(current_line, 1, current_col -1)
local byte_offset = vim.fn.byteidx(line_before_cursor, -1)
```

This code snippet calculates the byte offset of the cursor position using `vim.fn.byteidx()`.  This function correctly handles multibyte characters, ensuring the completion starts at the right place.  The `lua/rktmb-deepseek-complete.lua` file remains unchanged.


With this correction, pressing `<M-PageDown>` in insert mode should now correctly offer the randomly generated sentence as a completion.

