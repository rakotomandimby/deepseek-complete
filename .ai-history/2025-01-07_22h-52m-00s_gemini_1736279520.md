# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.
Also, now, if in INSERT mode and the user presses the space key, `suggest()` is called.

That is the behavior I want.

## Step 4: Insert the suggestion as extmark

Now the suggestion returned by the DeepSeek API is inserted as an extmark.
The extmark starts after the cursor position, NOT at the end of the line.

Problem: 
- The DeepSeek API response is a multiline string and it was displayed with `^@` at the end of each line.
- I already tried to fix it by splitting the string into lines and insert each line as a separate extmark
- The current result is that each inserted extmark is displayed one after the other, on the same line: I expect each extmark to be displayed each one on a separate line.

Tell me what modifications I need to make each extmark to be displayed on a separate line.




# This is gemini-exp-1206 answer (3k in, 0k out)

The issue with the `^@` characters appearing and the extmarks being placed on the same line stems from how you're handling the multi-line suggestions.  Virtual text using `virt_text` is designed to append text *after* a given screen position.  Therefore, placing multi-line virtual text at the same screen position will just concatenate the lines visually.

Here's the corrected `lua/rktmb-deepseek-complete.lua` file. The key change is in `M.set_suggestion_extmark`:

```lua
-- lua/rktmb-deepseek-complete.lua
-- Initialize a module
local M = {}

function M.log(message)
  local log_file = io.open("/tmp/rktmb-deepseek-complete.log", "a")
  -- check if log_file is nil
  if log_file == nil then
    print("Error opening log file")
    return
  end
  log_file:write(message .. "\n")
  log_file:close()
end

function M.remove_markdown_delimiters(text)
  local lines = vim.split(text, "\n", true)
  if lines[1]:sub(1, 3) == "```" then
    table.remove(lines, 1)
  end
  if lines[#lines]:sub(-3) == "```" then
    lines[#lines] = nil
  end
  return table.concat(lines, "\n")
end


function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]

  -- Split the suggestion into lines
  local lines = vim.split(suggestion, '\n', true)

  -- Clear existing extmarks
  if _G.current_extmark_ids then
    for _, id in ipairs(_G.current_extmark_ids) do
      vim.api.nvim_buf_del_extmark(current_buf, _G.ns_id, id)
    end
  end
  _G.current_extmark_ids = {}

  -- Create virtual text for each line at the correct position
  for i, line in ipairs(lines) do
    local current_row = row + i - 1
    local id = vim.api.nvim_buf_set_extmark(current_buf, _G.ns_id, current_row, col, {virt_text = {{line, "Comment"}}})
    table.insert(_G.current_extmark_ids, id)
  end
end


-- ... (rest of your rktmb-deepseek-complete.lua file)
```

Key changes:

1. **Clearing Previous Extmarks:**  We now store extmark IDs in a table `_G.current_extmark_ids` and clear them before setting new ones. This prevents ghosting of old suggestions.

2. **Iterating and Placing Extmarks:** The code now iterates through the `lines` table.  For each line, it calculates the correct row (`current_row`) and then sets the extmark at that row and the initial column.  This places each line of the suggestion on a new line.


No changes are needed in your `plugin/init.lua` file regarding the extmark handling.  This revised `M.set_suggestion_extmark` function should correctly display multi-line suggestions.  Make sure to test thoroughly!
