# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence picked from the list of sentences. The suggestion text must appear in grey.

The problem is that I get the following error when I issue the key sequence `<M-PageDown>` in insert mode:

```
E5108: Error executing lua: Vim:E565: Not allowed to change text or change window
stack traceback:
        [C]: in function 'complete'
        ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:14: 
in function <....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:7>
```

Analyze the code and tell me what should I do to fix the problem.



# This is gpt-4o-mini answer (0k in, 0k out)

The error you're encountering, `E565: Not allowed to change text or change window`, typically occurs when trying to modify the buffer or perform certain actions in Neovim while in insert mode, especially when using the `vim.fn.complete()` function.

### Analysis of the Code

In your `plugin/init.lua`, the key mapping for `<M-PageDown>` is set up to generate a random sentence and suggest it as a completion for the current word. However, the way you're calling `vim.fn.complete()` is causing the error because it is being executed in a context where Neovim does not allow text changes.

### Suggested Fix

To resolve this issue, you can use the `vim.api.nvim_buf_set_option()` function to set the completion options instead of directly calling `vim.fn.complete()`. You can also ensure that the completion is triggered correctly by using the `complete()` function in a way that respects the insert mode context.

Hereâ€™s how you can modify your `plugin/init.lua` to fix the issue:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        vim.keymap.set("i", "<M-PageDown>", function()
            local current_col = vim.api.nvim_win_get_cursor(0)[2]
            local current_word = vim.fn.expand("<cword>")

            local suggestion = rktmb_deepseek_complete.generate_sentence()

            -- Use the complete function to suggest the random sentence
            vim.fn.complete(current_col + 1, {
                { word = suggestion, kind = "random sentence", menu = "[random]", icase = 1, abbr = current_word }
            })
        end, { noremap = true, expr = true, silent = true })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
    end
})
```

### Key Changes Made

1. **Cursor Position Adjustment**: The `current_col + 1` is used in the `vim.fn.complete()` call to ensure that the completion is inserted at the correct position. The completion function expects the position to be one-based.

2. **Completion Context**: Ensure that the completion is triggered correctly in the context of insert mode.

### Additional Notes

- Make sure that your Neovim version supports the features you are using. If you are using an older version, consider updating to the latest stable release.
- Test the changes in a new buffer to ensure that the completion works as expected without any errors.

With these changes, you should be able to trigger the random sentence completion without encountering the error.

