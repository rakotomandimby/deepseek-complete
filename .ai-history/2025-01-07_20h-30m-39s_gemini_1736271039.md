# E5560: Vimscript function must not be called in a Lua callback

In `./plugin/init.lua` I have a function `process_deepseek_response()` that is called in the callback of the curl request.
The problem is that the function `process_deepseek_response()` must decode a json string, but it is a vimscript function.

Propose me the changes needed to make to able to decode the json in the response.




# This is gemini-exp-1206 answer (2k in, 1k out)

The error you're encountering, "E5560: Vimscript function must not be called in a Lua callback," arises because you're attempting to use `vim.fn.json_decode` (a Vimscript function wrapped for Lua) within a Lua callback function.  This isn't allowed due to how Neovim handles asynchronous operations and the interaction between Lua and Vimscript.

Here's the corrected `plugin/init.lua` using a pure Lua JSON library:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
local curl = require('plenary.curl')
local json = require("nui.utils.json") -- Import a pure Lua JSON library


_G.ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Default keymappings
local default_opts = {
  deepseek_api_key = os.getenv("DEEPSEEK_API_KEY"),
  suggest_lines_keymap = "<M-ESC>",
  accept_all_keymap = "<M-PageDown>",
  accept_line_keymap = "<M-Down>",
}

-- Read user configuration
local user_opts = vim.tbl_deep_extend("force", default_opts, vim.g.rktmb_deepseek_complete_opts or {})


local function process_deepseek_response(response)
  local response_body = json.decode(response.body) -- Use the Lua json library
  if response_body.choices and #response_body.choices > 0 then
    local choice = response_body.choices[1]
    local suggestion = choice.message.content
    rktmb_deepseek_complete.log("\n\nSuggestion from DeepSeek API:")
    rktmb_deepseek_complete.log(suggestion)

    -- Now that you have the suggestion, you can use it (e.g., display it to the user)
    _G.current_suggestion = suggestion  -- Store the suggestion globally
    -- ... (Code to insert/display the suggestion) ...

  end
end


_G.suggest = function()

  local deepseek_request_body = {
    model = "deepseek-chat",
    echo = false,
    frequency_penalty = 0,
    max_tokens = 4096,
    presence_penalty = 0,
    stop = nil,
    stream = false,
    stream_options = nil,
    temperature = 1,
    top_p = 1,
    messages = rktmb_deepseek_complete.build_messages_table(
      rktmb_deepseek_complete.get_text_before_cursor(),
      rktmb_deepseek_complete.get_text_after_cursor()
    )
  }

  -- Asynchronously make the POST request
  curl.post('https://api.deepseek.com/chat/completions', {
    body = vim.fn.json_encode(deepseek_request_body), -- This is still okay as it's before the callback
    headers = {
      ["Content-Type"] = "application/json",
      ["Accept"] = "application/json",
      ["Authorization"] = "Bearer " .. user_opts.deepseek_api_key
    },
    callback = function(response)
      rktmb_deepseek_complete.log("Response from DeepSeek API:")
      rktmb_deepseek_complete.log(response.body)
      process_deepseek_response(response)
    end
  })
end


vim.api.nvim_create_autocmd("InsertLeave", {
  pattern = "*",
  callback = function()
    vim.api.nvim_buf_clear_namespace(0, ns_id, 0, -1)
  end
})


vim.api.nvim_set_keymap("i", user_opts.suggest_lines_keymap, "<Cmd>lua suggest()<CR>",                     { noremap = true, silent = true })


```

Key Changes:

1. **Import `nui.utils.json`:** This line imports a pure Lua JSON library.  `nui.utils.json` is readily available if you're using `nui.nvim`. If not, you can install a standalone Lua JSON library like `dkjson`.

2. **Use `json.decode`:** Inside `process_deepseek_response`, replace `vim.fn.json_decode` with `json.decode(response.body)`.  This uses the Lua JSON library to parse the response body.

3. **Install `nui.nvim` (if needed):** If you choose to use `nui.utils.json`, make sure you have `nui.nvim` installed. You can install it using your plugin manager (e.g., Packer, vim-plug).  If you use a different JSON library, install that instead.


With these changes, you'll be able to decode the JSON response within your Lua callback without encountering the E5560 error.  I've also added a comment indicating where you would then use the `suggestion` (e.g., displaying it to the user or inserting it into the buffer).  You'll need to implement that part based on your desired behavior.
