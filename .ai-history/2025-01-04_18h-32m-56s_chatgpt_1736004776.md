# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence 
picked from the list of sentences. The suggestion text should appear in grey.

The problem is when I issue the key sequence `<M-PageDown>` in insert mode, nothing is suggested.

When I look in `/tmp/rktmb-deepseek-complete.log`, I see `Entered generate_sentence()`, so the plugin is actually trigerring the random sentence generation.

Analyze the code and tell me what should I do to fix the problem.



# This is gpt-4o-mini answer (1k in, 0k out)

The issue you're experiencing is likely due to how the completion is being triggered and how the completion items are being formatted. Let's analyze the relevant parts of your code and suggest a fix.

### Current Code Analysis

1. **Completion Handler**: The completion handler is set up correctly to generate a random sentence when `<M-PageDown>` is pressed.
2. **Completion Function**: The completion function uses `vim.fn.complete()` to suggest a completion. However, the way the completion item is structured may not be correctly interpreted by Neovim.

### Suggested Fix

To ensure that the completion suggestion appears correctly, you need to modify the completion item structure. Specifically, you should ensure that the completion item has the correct fields and that the completion is triggered properly.

Hereâ€™s how you can modify the `plugin/init.lua` file:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

_G.completion_handler = nil

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        -- Set the completion handler
        _G.completion_handler = function()
            local current_col = vim.api.nvim_win_get_cursor(0)[2]
            local suggestion = rktmb_deepseek_complete.generate_sentence()

            -- Create a completion item with the correct structure
            local completion_items = {
                { word = suggestion, kind = "Random Sentence", menu = "[random]", icase = 1 }
            }

            -- Trigger the completion
            vim.fn.complete(current_col + 1, completion_items)  -- Use current_col + 1 for the correct position
        end

        vim.keymap.set("i", "<M-PageDown>", function()
            vim.defer_fn(_G.completion_handler, 0)
            return ""
        end, { noremap = true, expr = true, silent = true })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        _G.completion_handler = nil -- Clear the handler when leaving insert mode
    end
})
```

### Key Changes Made

1. **Completion Item Structure**: The completion item now has the `kind` and `menu` fields set correctly. The `kind` is set to "Random Sentence", which helps in identifying the type of completion.
2. **Completion Position**: The completion is triggered at `current_col + 1` to ensure that the suggestion appears at the correct position in the text.

### Testing the Changes

After making these changes, restart Neovim and test the following:

1. Open a buffer and enter insert mode.
2. Type a word and then press `<M-PageDown>`.
3. You should see a random sentence suggested as a completion.

### Conclusion

These changes should resolve the issue of the completion not appearing when you trigger it. If you encounter any further issues, check the Neovim logs for any errors or additional information.

