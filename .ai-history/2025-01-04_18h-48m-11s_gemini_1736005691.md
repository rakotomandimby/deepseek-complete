# Propose completion from the random sentence generator

The final goal of this project is to be a code completion plugin that uses the DeepSeek API to suggest completions.
But we are not going to implement all in one go.
We are to make it step by step.

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a random sentence.

## Step 2: Suggest a completion from a random sentence when triggered.

When I am in a buffer and in INSERT mode, if I issue the key sequence `<M-PageDown>`,
then the plugin should suggest to complete the current word with a random sentence 
picked from the list of sentences. The suggestion text should appear in grey.

The problem is when I issue the key sequence `<M-PageDown>`, the completion actually written in the buffer and doesn't behave as an inline suggestion.

I want it to be an inline suggestion, not a typed text.

Analyze the code and tell me what should I do to make it an inline suggestion.





# This is gemini-2.0-flash-thinking-exp answer (1k in, 0k out)

The issue lies in how you're using the `vim.fn.complete()` function.  This function *inserts* the completion directly rather than showing it as a preview/suggestion.  Neovim's built-in completion framework (using `completefunc`) combined with the `pumvisible()` function provides the preview functionality you're looking for.

Here's the modified `plugin/init.lua` to achieve inline suggestions:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
rktmb_deepseek_complete.log("Entered init.lua")

vim.api.nvim_create_autocmd("InsertEnter", {
    pattern = "*",
    callback = function()
        -- Set the completefunc
        vim.o.completefunc = "v:lua.completion_handler"

        _G.completion_handler = function(findstart, base)
            if findstart == 1 then
                -- Finding start of the completion
                return vim.api.nvim_win_get_cursor(0)[2] - 1
            else
                local suggestions = {}
                local suggestion = rktmb_deepseek_complete.generate_sentence()
                table.insert(suggestions, { word = suggestion, kind = "random sentence", menu = "[random]", icase = 1, abbr = base })
                return suggestions
            end
        end


        -- Use <C-n> and <C-p> for navigating suggestions (default mappings)
        vim.keymap.set("i", "<M-PageDown>", function()
          -- Check if the popup menu is already visible
          if vim.fn.pumvisible() == 0 then
            -- Trigger completion if the popup menu is not visible
            vim.cmd [[call feedkeys("\<C-n>", 'n')]] -- Use <C-n> to initiate completion
          end
          return ""
        end, { noremap = true, expr = true, silent = true })
    end
})

vim.api.nvim_create_autocmd("InsertLeave", {
    pattern = "*",
    callback = function()
        vim.keymap.del("i", "<M-PageDown>")
        vim.o.completefunc = "" -- Clear the completefunc
        _G.completion_handler = nil -- Clear the handler
    end
})
```

Key changes and explanations:

1. **`completefunc`:** We now use `vim.o.completefunc = "v:lua.completion_handler"` to register our completion handler with Neovim's completion system.  This is the core of making the suggestions appear as previews.

2. **Completion Handler Structure:** The `completion_handler` function now adheres to the expected format for `completefunc`.  It receives `findstart` and `base` arguments.  When `findstart` is 1, it should return the byte index of the start of the completion. Otherwise, it returns a table of completion items.

3. **`pumvisible()`:** We use `vim.fn.pumvisible()` to check if the completion popup menu is already visible. This prevents re-triggering the completion if the menu is already open, allowing you to cycle through suggestions with `<C-n>` (or other completion keybindings).

4. **Triggering Completion:** We use `vim.cmd [[call feedkeys("\<C-n>", 'n')]]` to simulate pressing `<C-n>`, which is the default keybinding to trigger and navigate the completion menu.  This ensures the completion menu appears.

5. **Clearing `completefunc`:**  In the `InsertLeave` autocommand, we clear the `completefunc` by setting it to an empty string (`vim.o.completefunc = ""`). This is crucial to prevent interference with other plugins or Neovim's default completion behavior when you're not in insert mode.


With these changes, pressing `<M-PageDown>` in insert mode will now show a preview of the random sentence as a completion suggestion, and you can use `<C-n>` and `<C-p>` (or other configured completion keys) to navigate and select the suggestion.  The suggestion will be inserted only when you select it.



The `lua/rktmb-deepseek-complete.lua` file remains unchanged.

