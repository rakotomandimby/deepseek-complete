# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.

Now I want that if in INSERT mode and the user presses a letter key, a punctuation key, or a space, `suggest()` is called.

Tell me what modifications I need to make to the code in order to achieve that.




# This is gemini-exp-1206 answer (2k in, 0k out)

You want to trigger the `suggest()` function whenever a printable character is typed in insert mode.  Here's how to modify your `plugin/init.lua` to achieve this:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
local curl = require('plenary.curl')

_G.ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Default keymappings
local default_opts = {
  deepseek_api_key = os.getenv("DEEPSEEK_API_KEY"),
  suggest_lines_keymap = "<M-ESC>", -- Keep this for explicit suggestions
}

-- Read user configuration
local user_opts = vim.tbl_deep_extend("force", default_opts, vim.g.rktmb_deepseek_complete_opts or {})

local function process_deepseek_response(response)
  -- ... (Your existing process_deepseek_response function remains unchanged)
end

_G.suggest = function()
  -- ... (Your existing suggest function remains unchanged)
end


vim.api.nvim_create_autocmd("InsertLeave", {
  pattern = "*",
  callback = function()
    vim.api.nvim_buf_clear_namespace(0, ns_id, 0, -1)
  end
})

-- Keymap for explicit suggestion (keep this)
vim.api.nvim_set_keymap("i", user_opts.suggest_lines_keymap, "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })

-- Autocmd for triggering suggestions on printable characters
vim.api.nvim_create_autocmd("InsertCharPre", {
    pattern = "*",
    callback = function()
        -- Check if the typed character is printable.  This avoids triggering on <Esc>, <BS>, etc.
        local char = vim.api.nvim_get_current_buf()[0]
        if string.match(char, "%%%%p") or string.match(char, "%%%%s") or string.match(char, "%%%%a") then
            suggest()
        end
    end
})


-- ... (Remove the old accept keymaps; we'll add those back later)
```


Key changes:

1. **`InsertCharPre` Autocommand:**  This autocommand triggers *before* a character is inserted in insert mode.  This is crucial for getting the correct text before the cursor.

2. **Printable Character Check:** The `if` condition inside the autocommand callback checks if the typed character (`char`) is:
    - `%%%%p`: Punctuation
    - `%%%%s`: Whitespace (including space)
    - `%%%%a`: Alphabetic

    This ensures that `suggest()` is only called when a relevant character is typed.  It prevents unnecessary calls when you press keys like Escape, Backspace, arrow keys, etc.


With this modification, the `suggest()` function, and therefore the DeepSeek API call, will be triggered whenever you type a letter, punctuation, or space in insert mode, providing more dynamic and automatic suggestions.  You still retain the `<M-ESC>` keymap for explicitly requesting suggestions when needed.  We'll address handling the suggestions themselves (displaying and accepting) in the next steps.
