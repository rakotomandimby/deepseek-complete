# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.
Also, now, if in INSERT mode and the user presses the space key, `suggest()` is called.

That is the behavior I want.

## Step 4: Insert the suggestion as extmark

Now the suggestion returned by the DeepSeek API is inserted as an extmark.
The extmark starts after the cursor position, NOT at the end of the line.

Problem: 
- The DeepSeek API response is a multiline string and it was displayed with `^@` at the end of each line.
- I already tried to fix it by splitting the string into lines and insert each line as a separate extmark
- The current result is that each inserted extmark is displayed one after the other, on the same line: I expect each extmark to be displayed each one on a separate line.

Tell me what modifications I need to make each extmark to be displayed on a separate line.




# This is gpt-4o-mini answer (3k in, 0k out)

To ensure that each extmark is displayed on a separate line when inserting suggestions from the DeepSeek API, you need to modify the `set_suggestion_extmark` function in your `lua/rktmb-deepseek-complete.lua` file. The key is to adjust the row position for each line of the suggestion when creating the extmarks.

Here's how you can modify the `set_suggestion_extmark` function:

### Updated `set_suggestion_extmark` Function

```lua
function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]

  -- Split the suggestion into lines
  local lines = vim.split(suggestion, '\n', true)

  -- Create virtual text segments for each line
  local virt_text_lines = {}
  for _, line in ipairs(lines) do
    table.insert(virt_text_lines, {line, "Comment"})
  end

  -- Insert each line as a separate extmark
  for i, line in ipairs(lines) do
    local extmark_row = row + i - 1 -- Increment the row for each line
    if _G.current_extmark_id then
      -- Update existing extmark
      vim.api.nvim_buf_set_extmark(
        current_buf,
        _G.ns_id,
        extmark_row,
        col,
        {
          virt_text = {{line, "Comment"}},
        }
      )
    else
      -- Create new extmark
      _G.current_extmark_id = vim.api.nvim_buf_set_extmark(
        current_buf,
        _G.ns_id,
        extmark_row,
        col,
        {
          virt_text = {{line, "Comment"}},
        }
      )
    end
  end
end
```

### Explanation of Changes

1. **Loop Through Each Line**: Instead of creating a single extmark for the entire suggestion, we loop through each line of the suggestion.
  
2. **Adjust Row for Each Line**: The `extmark_row` variable is calculated by adding the index of the line to the original row position. This ensures that each line is placed on a new line in the buffer.

3. **Create/Update Extmarks**: For each line, we create or update an extmark with the corresponding row and the virtual text for that line.

### Additional Considerations

- Ensure that the `suggest()` function correctly handles the response from the DeepSeek API and calls `set_suggestion_extmark` with the appropriate suggestion string.
- You may want to clear existing extmarks before inserting new ones to avoid cluttering the buffer with multiple suggestions.

### Final Note

With these modifications, each suggestion line from the DeepSeek API will be displayed as a separate extmark, allowing for a clearer and more organized presentation of inline suggestions in Neovim.

