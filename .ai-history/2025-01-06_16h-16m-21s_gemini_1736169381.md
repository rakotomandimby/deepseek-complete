# Propose inline suggestions from the random sentence generator

The final goal of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest.
But we are not going to implement all in one go, we are to make it step by step.

- Generate random sentences
- Make an inline suggestion from a random sentence when triggered.
- Have the possibility transform the inline suggestion into regular text (accepting the suggestion).
- Query the DeepSeek API to get suggestions from the content of the buffer.
- Use the DeepSeek API response to suggest completions (dont use the random sentences anymore)

## Step 1: Generate a random sentence

in `./lua/rktmb-deepseek-complete.lua`, there is a function called `generate_sentence()`.
That function generates a multiline random sentence.
This is done.

## Step 2: Make an inline  suggestion from a random sentence when triggered.

When I am in a buffer and in INSERT mode and issue the key sequence `<M-PageDown>`,
The plugin to place de cursor at the end of the line and then insert an inline suggestion 
taken from a random sentence (which is multi line) picked from the list of sentences.
The suggestion appears in grey (#808080).
The suggestion pushes down the lines below it and does not overlap with the text below.
If I continue to type after the suggestion is displayed, the suggestion disappears.
As far as I type, I can trigger the suggestion again and if I continue to type, the suggestion disappears, again and again.

That is the desired behavior.

## Step 3: Have the possibility transform the inline suggestion into regular text (accepting the suggestion).

I want to transform the inline suggestion into regular text because I like that suggested sentence.

With the current `./plugin/init.lua` file,
I issue the `<M-PageUp>` key sequence, the suggestion is transformed into regular text.

But before the suggestion is transformed into regular text, I get the following error:

```
E5108: Error executing lua ....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: attempt to get length of field 'current_suggestion' (a nil value)
stack traceback:
....local/share/nvim/lazy/deepseek-complete/plugin/init.lua:74: in function 'accept_suggestion'
[string ":lua"]:1: in main chunk
```

Analyze the code and tell me what makes the error appear but the suggestion is transformed into regular text anyway.




# This is gemini-1.5-pro-latest answer (2k in, 0k out)

The error `E5108: attempt to get length of field 'current_suggestion' (a nil value)` arises because you're trying to access `#_G.current_suggestion` inside `accept_suggestion()` after it has potentially been set to `nil`.  Let's break down why this happens and how to fix it.

**Root Cause:**

1. **`TextChangedI` and `InsertLeave` Autocommands:** Inside `suggest_random_sentence()`, you attach autocommands to `TextChangedI` and `InsertLeave` events. These autocommands clear `_G.current_suggestion` when you type anything *or* leave insert mode.

2. **`<M-PageUp>` in Insert Mode:** You've mapped `<M-PageUp>` to `accept_suggestion()`.  If you trigger the suggestion with `<M-PageDown>` and *then* type even a single character before pressing `<M-PageUp>`, the `TextChangedI` autocommand will have already fired, setting `_G.current_suggestion` to `nil`.  The same happens if you leave insert mode and reenter it before accepting.

3. **Error on `#_G.current_suggestion`:**  Within `accept_suggestion()`, the line `vim.api.nvim_win_set_cursor(0, { current_line + #_G.current_suggestion, 0 })` attempts to get the length of `_G.current_suggestion` using `#`.  Since `_G.current_suggestion` is now `nil`, this throws the error.

**Why the suggestion is still inserted (sometimes):**

The error occurs *after* the suggestion has already been inserted into the buffer with `vim.api.nvim_buf_set_lines()`.  So, the text insertion happens successfully, but the subsequent attempt to position the cursor causes the error.  If you accept the suggestion *without* triggering the `TextChangedI` autocommand (i.e., without typing anything after the suggestion appears), the error won't occur.



**Solution:**

Guard against `_G.current_suggestion` being `nil` inside `accept_suggestion()`:

```lua
_G.accept_suggestion = function()
  if not _G.current_extmark_id or not _G.current_suggestion then
    return -- No active suggestion
  end

  local bufnr = 0
  local cursor_pos = vim.api.nvim_win_get_cursor(0)
  local current_line = cursor_pos[1]

  vim.api.nvim_buf_set_lines(bufnr, current_line, current_line, false, _G.current_suggestion)

  vim.api.nvim_buf_del_extmark(bufnr, ns_id, _G.current_extmark_id)

  _G.current_extmark_id = nil
  _G.current_suggestion = nil


  -- Fix: Check if _G.current_suggestion is nil before using #
  if _G.current_suggestion then
    vim.api.nvim_win_set_cursor(0, { current_line + #_G.current_suggestion, 0 })
  else
    --  Just move the cursor to the beginning of the next line if the suggestion is nil
    vim.api.nvim_win_set_cursor(0, { current_line + 1, 0 }) -- Or handle it differently
  end
end
```

By adding the `if _G.current_suggestion then ... else ... end` block, you prevent the error and provide a fallback cursor positioning.  You can adjust the fallback behavior (e.g., move to the next line, stay on the current line) as needed.  This revised code ensures that even if `_G.current_suggestion` is `nil`, the function will execute without errors.
