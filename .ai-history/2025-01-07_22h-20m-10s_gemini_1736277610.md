# Invalid `end_row` : out of range

When `M.set_suggestion_extmark()` is called with the suggestion returned by the DeepSeek API, I get the following error:

```
Error executing vim.schedule lua callback : rktmb-deepseek-complete.lua:57: Invalid `end_row` : out of range
```

I have no data sample to reproduce this error, may be you can find it out.
Analyze the code and tell me what actions should be made.




# This is gemini-exp-1206 answer (3k in, 0k out)

The error `Invalid 'end_row': out of range` in `M.set_suggestion_extmark` arises when the calculated `end_row` for the virtual text exceeds the actual number of lines in the buffer. This happens when the suggestion returned by the DeepSeek API contains more lines than available in the buffer after the cursor position.

Here's a breakdown of the issue and the solution:

1. **Problem:** The current `end_row` calculation assumes the suggestion will always fit within the buffer.  It calculates the end row based on the number of lines in the suggestion: `row + #vim.split(suggestion, '\n', true) - 1`. If the cursor is near the end of the buffer and the suggestion has multiple lines, this calculation can lead to an `end_row` that is beyond the buffer's limits.

2. **Solution:**  The `end_row` needs to be capped at the maximum allowed row index, which is the total number of lines in the buffer minus 1 (since it's 0-indexed).

Here's the corrected `lua/rktmb-deepseek-complete.lua` file:

```lua
-- lua/rktmb-deepseek-complete.lua
-- ... (rest of the code) ...

function M.set_suggestion_extmark(suggestion)
  local current_buf = vim.api.nvim_get_current_buf()
  local position = vim.api.nvim_win_get_cursor(0)
  local row = position[1] - 1 -- Adjust to 0-based indexing
  local col = position[2]
  local lines = vim.split(suggestion, '\n', true)
  local end_row = math.min(row + #lines - 1, vim.api.nvim_buf_line_count(current_buf) - 1) -- Cap end_row
  local end_col = string.len(lines[#lines])


  if _G.current_extmark_id then
    -- Update existing extmark
    vim.api.nvim_buf_set_extmark(current_buf, _G.ns_id, _G.current_extmark_id, {
      row = row,
      col = col,
      opts = {
        end_row = end_row,
        end_col = end_col,
        virt_text =  {{suggestion, "Comment"}},
        virt_text_pos = "overlay"
      }
    })
  else
    -- Create new extmark
    _G.current_extmark_id = vim.api.nvim_buf_set_extmark(
      current_buf,
      _G.ns_id,
      row,
      col,
      {
        end_row = end_row,
        end_col = end_col,
        virt_text = {{suggestion, "Comment"}},
        virt_text_pos = "overlay"
      }
    )
  end
end

-- ... (rest of the code) ...
```

**Explanation of Changes:**

* We use `vim.api.nvim_buf_line_count(current_buf)` to get the total number of lines in the current buffer.
* `math.min()` is used to select the smaller value between the calculated `end_row` and the maximum possible row index. This ensures `end_row` never goes out of bounds.
* The `end_col` calculation is also improved to correctly handle multi-line suggestions.


By implementing this change, the `end_row` will always be within the valid range, preventing the "out of range" error.  The `plugin/init.lua` file doesn't require any modifications. This fix addresses the root cause of the error, making the code more robust.  If you still encounter issues, double-check that your DeepSeek API key is correctly configured.  Let me know if you have any other questions.

