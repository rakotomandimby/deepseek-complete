# Propose inline suggestions from DeepSeek API

The final purpose of this project is to be an inline suggestion plugin that uses the DeepSeek API to suggest completions.

I already have some pieces of code.
I need you to generate the missing parts.

## Step 1: Get the text from the beginning of the current buffer to the cursor

The cursor position is a tuple of (row, column), where row is the line number and column is the character position within the line.
The code to get the text from the beginning of the current buffer to the cursor is `./lua/rktmb-deepseek-complete.lua` function `M.get_text_before_cursor()`.

## Step 2: Get the text from the cursor to the end of the current buffer

In `./lua/rktmb-deepseek-complete.lua` I created the function `M.get_text_after_cursor()` 
that returns the text from the cursor to the end of the current buffer.

## Step 3: Query the DeepSeek API

When the user presses `<M-ESC>`, the function `suggest()` is called. That is the behavior I want.

Now I want that if in INSERT mode and the user presses a letter key, a punctuation key, or a space, `suggest()` is called.

Tell me what modifications I need to make to the code in order to achieve that.




# This is gpt-4o-mini answer (2k in, 1k out)

To achieve the desired behavior of calling the `suggest()` function when the user presses a letter key, a punctuation key, or a space while in INSERT mode, you will need to modify the key mappings in your `plugin/init.lua` file. 

Here's how you can do it:

### Step 1: Modify Key Mappings

You will need to set up a key mapping that captures the relevant key presses. In Neovim, you can use the `vim.api.nvim_set_keymap` function to bind keys to the `suggest()` function.

### Step 2: Update `plugin/init.lua`

You can add a mapping for the letter keys, punctuation keys, and space. Below is the modified content of your `plugin/init.lua` file with the necessary changes:

```lua
local rktmb_deepseek_complete = require("rktmb-deepseek-complete")
local curl = require('plenary.curl')

_G.ns_id = vim.api.nvim_create_namespace('rktmb-deepseek-complete')

_G.current_extmark_id = nil
_G.current_suggestion = nil

-- Default keymappings
local default_opts = {
  deepseek_api_key = os.getenv("DEEPSEEK_API_KEY"),
  suggest_lines_keymap = "<M-ESC>",
  accept_all_keymap = "<M-PageDown>",
  accept_line_keymap = "<M-Down>",
}

-- Read user configuration
local user_opts = vim.tbl_deep_extend("force", default_opts, vim.g.rktmb_deepseek_complete_opts or {})
local function process_deepseek_response(response)
  vim.schedule(function()  -- Use vim.schedule to run this in the main thread
    local response_body = vim.fn.json_decode(response.body)
    if response_body.choices and #response_body.choices > 0 then
      local choice = response_body.choices[1]
      local suggestion = choice.message.content
      rktmb_deepseek_complete.log("\n\nSuggestion from DeepSeek API:")
      rktmb_deepseek_complete.log(suggestion)
    end
  end)
end

_G.suggest = function()
  local deepseek_request_body = {
    model = "deepseek-chat",
    echo = false,
    frequency_penalty = 0,
    max_tokens = 4096,
    presence_penalty = 0,
    stop = nil,
    stream = false,
    stream_options = nil,
    temperature = 1,
    top_p = 1,
    messages = rktmb_deepseek_complete.build_messages_table(
      rktmb_deepseek_complete.get_text_before_cursor(),
      rktmb_deepseek_complete.get_text_after_cursor()
    )
  }

  -- Asynchronously make the POST request
  curl.post('https://api.deepseek.com/chat/completions', {
    body = vim.fn.json_encode(deepseek_request_body),
    headers = {
      ["Content-Type"] = "application/json",
      ["Accept"] = "application/json",
      ["Authorization"] = "Bearer " .. user_opts.deepseek_api_key
    },
    callback = function(response)
      rktmb_deepseek_complete.log("Response from DeepSeek API:")
      rktmb_deepseek_complete.log(response.body)
      process_deepseek_response(response)
    end
  })
end

vim.api.nvim_create_autocmd("InsertLeave", {
  pattern = "*",
  callback = function()
    vim.api.nvim_buf_clear_namespace(0, ns_id, 0, -1)
  end
})

-- Key mappings
vim.api.nvim_set_keymap("i", user_opts.suggest_lines_keymap, "<Cmd>lua suggest()<CR>", { noremap = true, silent = true })

-- Add mappings for letter keys, punctuation keys, and space
for i = 97, 122 do  -- a-z
  vim.api.nvim_set_keymap("i", string.char(i), "<C-o>lua suggest()<CR>" .. string.char(i), { noremap = true, silent = true })
end

for i = 65, 90 do  -- A-Z
  vim.api.nvim_set_keymap("i", string.char(i), "<C-o>lua suggest()<CR>" .. string.char(i), { noremap = true, silent = true })
end

-- Punctuation keys
local punctuation_keys = { "!", '"', "#", "$", "%%", "&", "'", "(", ")", "*", "+", ",", "-", ".", "/", ":", ";", "<", "=", ">", "?", "@", "[", "\\", "]", "^", "_", "`", "{", "|", "}", "~" }
for _, key in ipairs(punctuation_keys) do
  vim.api.nvim_set_keymap("i", key, "<C-o>lua suggest()<CR>" .. key, { noremap = true, silent = true })
end

-- Space key
vim.api.nvim_set_keymap("i", " ", "<C-o>lua suggest()<CR> ", { noremap = true, silent = true })

-- Uncomment these if you want to use them
-- vim.api.nvim_set_keymap("i", user_opts.accept_all_keymap,    "<Cmd>lua accept_the_whole_suggestion()<CR>", { noremap = true, silent = true })
-- vim.api.nvim_set_keymap("i", user_opts.accept_line_keymap,   "<Cmd>lua accept_one_suggestion_line()<CR>",  { noremap = true, silent = true })
-- vim.api.nvim_set_keymap("i", user_opts.accept_word_keymap   ,"<Cmd>lua accept_one_suggestion_word()<CR>",  { noremap = true, silent = true })
```

### Explanation of Changes

1. **Key Mappings for Letters**: The code now includes a loop that sets key mappings for lowercase (`a-z`) and uppercase (`A-Z`) letters. When any letter is pressed, it will call the `suggest()` function.

2. **Key Mappings for Punctuation**: A list of punctuation keys is defined, and a loop sets key mappings for each punctuation character. Pressing any of these keys will also call the `suggest()` function.

3. **Space Key Mapping**: The space key is mapped to call the `suggest()` function when pressed.

### Note

- The `<C-o>` prefix is used to allow the original key press to be processed after calling `suggest()`. This ensures that the character is still inserted into the buffer.
- Make sure to test the behavior in Neovim to ensure it meets your expectations. Adjust the key mappings as necessary based on your preferences.

